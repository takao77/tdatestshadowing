<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚³ãƒ¼ã‚¹ç®¡ç†</title>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
            crossorigin="anonymous"
            referrerpolicy="no-referrer"
    />
    <style>
    body { background: #f5f5f5; color: #333; font-family: sans-serif; padding: 20px; }
    h1 { text-align: center; margin-bottom: 1em; }
    form { max-width: 600px; margin: auto 0 2em; padding: 1em; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    form input, form select { width: calc(100% - 12px); padding: 6px; margin-bottom: 1em; border: 1px solid #ccc; border-radius: 4px; }
    form label { display: block; margin-bottom: 0.5em; }
    form button { padding: 8px 16px; border: none; border-radius: 4px; background: #3498db; color: #fff; cursor: pointer; }
    form button:hover { background: #2980b9; }
    table { width: 100%; border-collapse: collapse; background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #fafafa; }
    .toggle-btn { cursor: pointer; color: #3498db; }
    .toggle-btn.off { color: #ccc; }
    .delete-btn { color: #e74c3c; cursor: pointer; }
    /* CSS ã«è¿½åŠ  */
    .public-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;       /* ãƒã‚§ãƒƒã‚¯ â‡„ æ–‡å­— ã®é–“éš” */
      margin-top: 1em;    /* ä¸Šã«å°‘ã—ä½™ç™½ */
      cursor: pointer; /* ãƒ©ãƒ™ãƒ«å…¨ä½“ãŒã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã« */
    }

    /* æ—¢å­˜ã® form label ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒå½±éŸ¿ã—ã¦ã„ã‚‹å ´åˆã¯ä¸Šæ›¸ã */
    form label {
      margin-bottom: .5em; /* ã‚‚ã—ä¸Šä¸‹ä½™ç™½ãŒå¤§ãã‘ã‚Œã°èª¿æ•´ */
    }
    /* ãƒœã‚¿ãƒ³è¡Œã¯ä¸‹ã«ã¾ã¨ã‚ */
    .form-actions {
      margin-top: 1em;    /* ãƒ©ãƒ™ãƒ«ã¨ã®é–“ã«ã‚¹ãƒšãƒ¼ã‚¹ */
    }

    /* ãƒœã‚¿ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯è¦ç´ ã«ã—ã¦å¹…ã„ã£ã±ã„ã«ã—ã¦ã‚‚OK */
    .form-actions button {
      display: inline-block;
    }
  </style>
</head>
<body>

  <h1>ã‚³ãƒ¼ã‚¹ç®¡ç†ç”»é¢</h1>

  <!-- è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
  <form id="add-course-form">
    <label for="course-name">ã‚³ãƒ¼ã‚¹åï¼š</label>
    <input type="text" id="course-name" placeholder="ä¾‹: TOEIC åˆç´š" required>

    <label for="course-language">è¨€èªã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼š</label>
    <select id="course-language">
      <option value="en">English</option>
      <option value="zh">ä¸­æ–‡</option>
      <option value="jp-kanji">æ—¥æœ¬èªï¼ˆæ¼¢å­—ï¼‰</option>
    </select>

    <!-- ğŸ”½ æ–°è¦: ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ -->
    <label for="course-category">ã‚³ãƒ¼ã‚¹ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼š</label>
    <select id="course-category">
      <!-- JS ã§å‹•çš„ã«æŒ¿å…¥ -->
    </select>

      <label for="course-public" class="public-label">
          <input type="checkbox" id="course-public" checked>
          <span>å…¬é–‹ã™ã‚‹</span>
      </label>

  <!-- ãƒœã‚¿ãƒ³ã¯æ”¹è¡Œã—ã¦ãƒ–ãƒ­ãƒƒã‚¯ã§é…ç½® -->
  <div class="form-actions">
      <button type="submit">
          <i class="fas fa-plus"></i> ã‚³ãƒ¼ã‚¹ã‚’è¿½åŠ 
      </button>
  </div>
  </form>

  <!-- ä¸€è¦§ãƒ†ãƒ¼ãƒ–ãƒ« -->
  <table>
    <thead>
      <tr>
        <th>ID</th>
        <th>ã‚³ãƒ¼ã‚¹å</th>
        <th>è¨€èª</th>
        <th>ã‚«ãƒ†ã‚´ãƒªãƒ¼</th>
        <th>å…¬é–‹</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody id="courses-tbody">
      <!-- JS ã§åŸ‹ã‚è¾¼ã¿ -->
    </tbody>
  </table>


  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
      // ------------------ ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã®å–å¾— ------------------
      async function fetchCategories() {
          try {
              const res = await fetch('/api/get_categories');
              const data = await res.json();
              if (!Array.isArray(data.categories)) throw new Error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“');
              const $sel = $('#course-category').empty();
              data.categories.forEach(c => {
                  $sel.append(`<option value="${c.id}">${c.name}</option>`);
              });
          } catch (err) {
              console.error(err);
              alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
          }
      }

      async function fetchCourses() {
          const res = await fetch('/api/get_courses_admin');
          const data = await res.json();
          const $tbody = $('#courses-tbody').empty();

          data.courses.forEach(course => {
              const pubClass = course.is_public ? '' : 'off';
              $tbody.append(`
            <tr data-id="${course.id}">
              <td>${course.id}</td>
              <td>${course.name}</td>
              <td>${course.language}</td>
              <td>${course.category_name||''}</td>
              <td>
                <i class="fas fa-toggle-${course.is_public ? 'on' : 'off'} toggle-btn ${pubClass}"
                   data-public="${course.is_public}"
                   title="å…¬é–‹/éå…¬é–‹åˆ‡æ›¿"></i>
              </td>
              <td>
                <!-- ç·¨é›†ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç¢ºå®Ÿã«è¡¨ç¤º -->
                <i class="fas fa-edit edit-btn"
                   style="cursor:pointer; color:#f39c12; margin-right:8px;"
                   title="ã‚³ãƒ¼ã‚¹ç·¨é›†"></i>
                <!-- å‰Šé™¤ã‚¢ã‚¤ã‚³ãƒ³ -->
                <i class="fas fa-trash delete-btn"
                   style="cursor:pointer; color:#e74c3c;"
                   title="ã‚³ãƒ¼ã‚¹å‰Šé™¤"></i>
              </td>
            </tr>
          `);
          });
      }

      // ç·¨é›†ï¼å‰Šé™¤ã®ãƒãƒ³ãƒ‰ãƒ©ã‚‚åˆã‚ã›ã¦å†å®šç¾©
      $('#courses-tbody')
              .on('click', '.edit-btn', async function () {
                  const $tr = $(this).closest('tr');
                  const id = $tr.data('id');
                  const name = prompt('æ–°ã—ã„ã‚³ãƒ¼ã‚¹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', $tr.find('td:nth-child(2)').text());
                  if (!name) return;
                  const lang = prompt('æ–°ã—ã„è¨€èªã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ (en, zh, jp-kanji)', $tr.find('td:nth-child(3)').text());
                  if (!lang) return;
                  const cat=prompt('æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªãƒ¼IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',currentCat);
                  if(cat===null) return;
                  const pub = $tr.find('.toggle-btn').data('public') ? 1 : 0;
                  const res = await fetch('/api/update_course', {
                      method: 'POST',
                      headers: {'Content-Type': 'application/json'},
                      body: JSON.stringify({course_id: id, name, language: lang, is_public: pub})
                  });
                  if (res.ok) fetchCourses();
                  else alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
              })
              .on('click', '.delete-btn', async function () {
                  if (!confirm('æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                  const id = $(this).closest('tr').data('id');
                  const res = await fetch(`/api/delete_course/${id}`, {method: 'DELETE'});
                  if (res.ok) fetchCourses();
                  else alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
              });

      // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å‘¼ã³å‡ºã—
      $(document).ready(() => {
          // â‘  å…ˆã«ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—ã—ã¦ <select id="course-category"> ã‚’åŸ‹ã‚ã‚‹
          fetchCategories()
                  // â‘¡ å–å¾—ãŒçµ‚ã‚ã£ãŸã‚‰ã‚³ãƒ¼ã‚¹ä¸€è¦§ã‚’æç”»
                  .then(fetchCourses)
                  // â‘¢ ã©ã¡ã‚‰ã‹ã§å¤±æ•—ã—ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                  .catch(err => {
                      console.error(err);
                      alert('åˆæœŸãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                  });
      });
      // è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒãƒ³ãƒ‰ãƒ©ï¼ˆã“ã‚ŒãŒãªã„ã¨ /api/create_course ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã•ã‚Œã¾ã›ã‚“ï¼‰
      $('#add-course-form').on('submit', async function (e) {
          e.preventDefault();
          const name = $('#course-name').val().trim();
          const language = $('#course-language').val();
          const categoryId = Number($('#course-category').val());
          const isPublic = $('#course-public').is(':checked') ? 1 : 0;

          try {
              const res = await fetch('/api/create_course', {
                  method: 'POST',
                  headers: {'Content-Type': 'application/json'},
                  body:JSON.stringify({name,language,category_id:Number(categoryId),is_public:isPublic})
              });

              if (!res.ok) {
                  const error = await res.json();
                  throw new Error(error.error || res.statusText);
              }

              // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
              $('#course-name').val('');
              $('#course-public').prop('checked', true);
              await fetchCourses();

          } catch (err) {
              alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + err.message);
          }
      });

  </script>


</body>
</html>