{% extends 'base.html' %}
{% block title %}Vocabulary Boost{% endblock %}

{% block head %}
<style>
:root{
  --accent-from:#00e6ff;
  --accent-to:#8a35ff;
  --bg:#111;
  --glass:rgba(255,255,255,.06);
  --blur:12px;
}
body{background:var(--bg)!important;color:#fff}

/* ── 背景の淡いグラデぼかし ───────────────── */
.bg-float{
  position:fixed;inset:0;z-index:-1;pointer-events:none;
  background:radial-gradient(circle at 15% 35%,#00e6ff22 0 25%,transparent 55%),
             radial-gradient(circle at 80% 80%,#8a35ff22 0 25%,transparent 55%);
  filter:blur(80px);
}

/* ── 戻る（家）アイコン ───────────────── */
.back-btn{
  position:fixed;top:20px;left:22px;font-size:30px;color:#fff;
  text-decoration:none;padding:6px 14px;border-radius:12px;
  background:var(--glass);border:1px solid rgba(255,255,255,.15);
  backdrop-filter:blur(var(--blur));transition:.25s;
}
.back-btn:hover{background:rgba(255,255,255,.15);transform:scale(1.07)}

/* ── メインカード ────────────────────────── */
.card{
  backdrop-filter:blur(var(--blur));
  background:var(--glass);border:1px solid rgba(255,255,255,.14);
  border-radius:26px;padding:32px 28px;max-width:480px;margin:12vh auto;
  text-align:center;box-shadow:0 6px 28px rgb(0 0 0 / .45);
}
.stat{
  font-size:2.6rem;margin-bottom:6px;
  background:linear-gradient(135deg,var(--accent-from),var(--accent-to));
  -webkit-background-clip:text;color:transparent;
}
small{opacity:.75}

/* ── フレーバーチップ ─────────────────────── */
.flavor-chip{
  display:inline-block;margin:0 6px 12px;padding:8px 16px;
  border-radius:40px;font-size:.9rem;font-weight:600;cursor:pointer;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.08);
  transition:.25s;
}
.flavor-chip.active{
  background:linear-gradient(135deg,var(--accent-from),var(--accent-to));
}
.flavor-chip:hover{filter:brightness(1.2)}
#chip-sl   {color:#ff867d;}
#chip-idm  {color:#67e8f9;}
#chip-biz  {color:#facc15;}

/* ── Add 5 Words ボタン ──────────────────── */
#add-btn{
  display:inline-block;border:none;border-radius:50px;
  padding:14px 38px;margin:18px 0 26px;font-size:1rem;font-weight:600;
  color:#fff;background:linear-gradient(135deg,var(--accent-from),var(--accent-to));
  cursor:pointer;transition:.25s;
}
#add-btn:disabled{opacity:.55;cursor:not-allowed}
#add-btn:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 0 20px var(--accent-from)}

/* ── 候補＋例文リスト ──────────────────────── */
#cand-wrap{display:none}
#cand-list{list-style:none;padding-left:0;margin:0;font-size:1.05rem;line-height:1.38}
#cand-list li{margin:6px 0}
#cand-list li strong{color:var(--accent-from)}

/* ── Toast 受け皿 ─────────────────────────── */
#toast-wrap{
  position:fixed;
  top:22px;                     /* ← 画面上部 */
  left:50%; transform:translateX(-50%); /* 中央寄せ */
  z-index:2000;
  width:100%; max-width:380px;  /* 幅を制限しつつ中央 */
  display:flex; flex-direction:column; gap:12px; align-items:center;
}

/* ── Toast 本体のカスタム ─────────────────── */
.toast.vboost{
  width:100%;
  border:none;
  background:linear-gradient(135deg,#00e6ff,#8a35ff);
  color:#fff;
  font-family:'Poppins',sans-serif;
  font-size:1.06rem;
  font-weight:600;
  letter-spacing:.4px;
  text-align:center;
  padding:.85rem 1.2rem;
  border-radius:14px;
  box-shadow:0 6px 18px rgb(0 0 0 / .45);
}

#chip-gen{color:#e0e0e0;}      /* 薄いグレー文字 */
</style>
{% endblock %}

{% block body %}
<span class="bg-float"></span>

<a href="/home" class="back-btn"><i class="fa-solid fa-house-chimney-window"></i></a>

<div class="card">

  <!-- ====== フレーバー選択チップ ====== -->
  <div id="flavor-bar">
    <span id="chip-gen" class="flavor-chip active" data-flavor="general">General</span>
    <span id="chip-idm" class="flavor-chip" data-flavor="idiom">Idioms</span>
    <span id="chip-sl"  class="flavor-chip" data-flavor="slang">Gen-Z&nbsp;Slang</span>
    <span id="chip-biz" class="flavor-chip" data-flavor="business">Business</span>
  </div>

  <!-- ====== Add ボタン / 候補表示 ====== -->
  <button id="add-btn" style="display:none">
    <i class="fas fa-magic mr-1"></i>Add&nbsp;5&nbsp;Words
  </button>

    <p id="add-progress" style="display:none; margin:10px 0 0; font-weight:600;">
      <i class="fas fa-spinner fa-spin"></i> Generating…
    </p>

  <div id="cand-wrap">
    <ul id="cand-list"></ul>
  </div>

  <!-- ====== プロフィール表示 ====== -->
  <h2>Your Vocabulary Profile</h2>
  <div id="loading">Loading…</div>

  <div id="result" style="display:none">
    <div class="stat" id="lemma-num">—</div>
    <small id="cefr">CEFR: —</small>
    <p id="comment" style="margin-top:14px"></p>
  </div>
</div>

<div id="toast-wrap"></div>
{% endblock %}

{% block script %}
<script>
/* ---------- util ---------- */
const olderThan30 = iso => !iso || (Date.now()-Date.parse(iso))>30*24*60*60*1e3;

const toast = msg => {
  const id = 't' + Date.now();
  toastWrap.insertAdjacentHTML(
    'beforeend',
    `
      <div id="${id}" class="toast vboost" role="alert" data-delay="15000">
        <div class="toast-body">${msg}</div>
      </div>
    `
  );
  $('#' + id)
    .toast('show')
    .on('hidden.bs.toast', e => e.target.remove());
};


/* ---------- elem refs ---------- */
const lemmaNum=$('#lemma-num')[0];
const cefr    =$('#cefr')[0];
const comment =$('#comment')[0];
const addBtn  =$('#add-btn')[0];
const ul      =$('#cand-list')[0];
const candWrap=$('#cand-wrap')[0];
const toastWrap=$('#toast-wrap')[0];

/* ---------- ① プロフィール ---------- */
fetch('/api/personal_vocab/profile_cached')
 .then(r=>r.json())
 .then(j=>!j.ok||olderThan30(j.updated)
        ?fetch('/api/personal_vocab/profile').then(r=>r.json()) : j)
 .then(j=>{
    if(!j.ok) throw j.error||'error';
    lemmaNum.textContent=(j.lemmas||0).toLocaleString();
    cefr.textContent='CEFR: '+(j.cefr||'');
    comment.textContent=j.comment||'';
    $('#loading').hide(); $('#result').show(); addBtn.style.display='inline-block';
 })
 .catch(e=>$('#loading').text('Error: '+e));

/* ---------- ② フレーバー選択 ---------- */
let currentFlavor='general';
$('#flavor-bar .flavor-chip').on('click',function(){
  $('#flavor-bar .flavor-chip').removeClass('active');
  this.classList.add('active');
  currentFlavor=this.dataset.flavor;
});

/* ---------- ③ Add 5 Words ---------- */
addBtn.onclick = async () => {
  const prog = document.getElementById('add-progress');   // ← 進行中表示
  const wrap = document.getElementById('cand-wrap');

  /* --- 開始：UI ロック & メッセージ -------------------- */
  addBtn.disabled = true;
  addBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
  prog.style.display = 'block';          // 「Generating…」を表示
  wrap.style.display = 'none';           // 旧リストがあれば一旦隠す

  try {
    /* 3-1 候補 5 語 */
    const r = await fetch('/api/personal_vocab/candidates', {
      method  : 'POST',
      headers : {'Content-Type':'application/json'},
      body    : JSON.stringify({flavor: currentFlavor})
    });
    const cj = await r.json();
    if (!r.ok || !cj.ok) throw cj.error || 'candidate error';

    /* 3-2 例文付きで取得 & DB 追加 */
    const ex = await fetch('/api/personal_vocab/examples', {
      method  : 'POST',
      headers : {'Content-Type':'application/json'},
      body    : JSON.stringify({words: cj.words})
    });
    const ej = await ex.json();
    if (!ex.ok || !ej.ok) throw ej.error || 'example error';

    /* 3-3 画面反映 */
    ul.innerHTML = '';
    ej.examples.forEach(it => {
      ul.insertAdjacentHTML(
        'beforeend',
        `<li><strong>${it.word}</strong>: ${it.sentence}</li>`
      );
    });
    wrap.style.display = 'block';
    toast('5 words added to your personal dictionary!');
  } catch (e) {
    wrap.style.display = 'block';
    ul.innerHTML = `<li style="color:#f66">${e}</li>`;
  } finally {
    /* --- 終了：UI 戻し & メッセージ非表示 -------------- */
    addBtn.disabled = false;
    addBtn.innerHTML = '<i class="fas fa-magic mr-1"></i>Add&nbsp;5&nbsp;Words';
    prog.style.display = 'none';
  }
};

</script>
{% endblock %}
