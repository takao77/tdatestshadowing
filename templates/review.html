<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Review</title>

<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous"/>
<style>
:root{--bg:#1e1e1e;--blue:#3498db;--blue-light:#5dade2;--text:#fff;}
*{box-sizing:border-box;}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Raleway',sans-serif;
     display:flex;justify-content:center;align-items:center;min-height:100vh;}
.container{background:rgba(40,40,40,.85);max-width:540px;width:92%;padding:28px 26px;
           border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);text-align:center;position:relative;}
h1{font-size:1.25rem;margin:0 0 22px}
#jp{font-size:1.2rem;font-weight:600;margin:6px 0 12px;color:var(--blue-light);}
#ef{font-size:.85rem;opacity:.8;margin-bottom:10px;}
#result-msg{margin-top:12px;font-size:1rem;}
input#answer{width:100%;padding:10px;border-radius:6px;border:none;font-size:1rem;}
.btn{margin-top:20px;padding:10px 26px;font-size:1rem;border:none;border-radius:50px;
     background:var(--blue);color:#fff;cursor:pointer;transition:background .2s;}
.btn:hover{background:#2980b9}
.btn:disabled{opacity:.4;cursor:not-allowed;}
#next-btn{margin-top:26px;}
a.home,a.logout{position:absolute;top:18px;color:#fff;text-decoration:none}
a.home{left:20px;font-size:30px}
a.logout{right:20px;padding:8px 14px;background:#7f8c8d;border-radius:6px}
a.logout:hover{background:#95a5a6}
@media(max-width:600px){
  body{align-items:flex-start;padding-top:70px}
  .container{width:100%;height:calc(100vh - 90px);overflow-y:auto}
}
</style>
</head>
<body>

<a href="/home" class="home"><i class="fa-solid fa-house-chimney-window"></i></a>
<a href="/logout" class="logout">Logout</a>

<div class="container">
  <h1>Review</h1>

<div id="player-wrap" style="margin:10px 0">
  <button id="play-btn" class="icon-btn" title="Play sentence" style="display:none">
      <i class="fas fa-volume-up"></i>
  </button>
  <audio id="tts-audio" style="display:none"></audio>
</div>

  <div id="prompt">Loading‚Ä¶</div>        <!-- sentence or JP -->
    <div id="jp-trans" style="margin-top:6px;opacity:.8;font-size:.9rem;"></div>
    <div id="ef"></div>

  <input id="answer" placeholder="" autocomplete="off">
  <button id="check-btn" class="btn">Check</button>

  <div id="result-msg"></div>

  <button id="next-btn" class="btn" disabled>Next</button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>

let cur=null;

/* ‚ñº ‚ë† „É¨„Éº„Éô„É≥„Ç∑„É•„Çø„Ç§„É≥Ë∑ùÈõ¢ÔºàÊúÄÂ∞èÁ∑®ÈõÜË∑ùÈõ¢Ôºâ */
function lev(a,b){
  const m=a.length,n=b.length,dp=[...Array(m+1)].map(()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++)
    for(let j=1;j<=n;j++)
      dp[i][j]=Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1)
      );
  return dp[m][n];
}

function loadNext(){
  $('#prompt').text('Loading‚Ä¶'); $('#ef,#result-msg').text('');
  $('#answer').val('').prop('disabled',false).focus();
  $('#check-btn').prop('disabled',false); $('#next-btn').prop('disabled',true);

  $.getJSON('/api/review/next').done(j=>{
      if(j.finished){ $('#prompt').text('üéâ ‰ªäÊó•„ÅØÂÆå‰∫ÜÔºÅ'); $('#answer,#check-btn').prop('disabled',true); return;}
      cur=j;
      $('#play-btn').hide();
      if (j.mode === 'cloze') {
          $('#prompt').text(j.sentence);
          $('#jp-trans').text(j.jp || '');
          $('#answer').attr('placeholder', 'Á©∫Ê¨Ñ„ÇíÂüã„ÇÅ„ÇãËã±ÂçòË™û / Âè•ÂãïË©û');
      } else if(j.mode==='jp'){
          $('#prompt').text(j.jp);
          $('#jp-trans').text('');        // Ë®≥„ÅØ‰∏çË¶Å
          $('#answer').attr('placeholder', 'Êó•Êú¨Ë™û„ÅÆËã±Ë™ûË®≥„ÇíÂÖ•Âäõ');
      }else if(j.mode==='dict'){
          $('#prompt').text('üéß Listen and type the sentence');
          $('#jp-trans').text('');
          $('#answer').attr('placeholder', 'Type what you hear');
          // „Åô„ÅêÈü≥Â£∞ÂÜçÁîü
          $('#tts-audio').attr('src', 'data:audio/mp3;base64,' + j.audio).get(0).play();

          $('#play-btn').show().off('click').on('click', ()=> {
            $('#tts-audio').get(0).currentTime = 0;
            $('#tts-audio').get(0).play();
          });
      }
      $('#ef').text('EF: '+j.ef.toFixed(2));
  }).fail(()=>$('#prompt').text('Error'));
}

// ÊàêÂê¶ÁµêÊûú„ÇíDB„Å´Êõ∏„ÅçËæº„ÇÄ„Éò„É´„Éë„ÉºÈñ¢Êï∞
function postResult(score){
  const fd=new FormData();
  fd.append('vocab_id',cur.vocab_id);
  fd.append('score',score);          // ‚Üê correct „Åß„ÅØ„Å™„Åè score
  return fetch('/api/review/result',{method:'POST',body:fd});
}

// Ê≠£Ë¶èÂåñ„Éò„É´„Éë
const norm = s => s
    .toLowerCase()          // Â§ßÊñáÂ≠ó„ÉªÂ∞èÊñáÂ≠ó„ÇíÂêå‰∏ÄË¶ñ
    .replace(/[^a-z]/g,''); // Ëã±Â≠ó‰ª•Â§ñÔºàÁ©∫ÁôΩ„Éª„Éè„Ç§„Éï„É≥„ÉªÂè•Ë™≠ÁÇπ„Å™„Å©Ôºâ„ÇíÂÖ®ÈÉ®ÂâäÈô§

$('#check-btn').on('click', async ()=>{

    const ansNorm = norm($('#answer').val());
    if (!ansNorm) return;
    const target = norm(cur.mode === 'cloze' ? cur.answer
            : cur.mode === 'jp' ? cur.word
                    : cur.full_sentence);  // dict „ÅØÂÖ®Êñá

    const dist = lev(ansNorm, target);
    let score, msg;
    if (dist === 0) {                     // ÂÆåÂÖ®‰∏ÄËá¥
        score = 5;
        msg = '‚úÖ Perfect!';
    } else if (dist <= 2) {                // ¬±2ÊñáÂ≠ó‰ª•ÂÜÖ
        score = 3;
        msg = `üí° Almost! (${dist} typo${dist>1?'s':''})<br>
            Correct: <b>${
                cur.mode==='dict'
                    ? cur.full_sentence
                    : (cur.answer || cur.word)
            }</b>`;
    } else {
        score = 1;
        msg = `‚ùå Correct: <b>${cur.mode==='dict'
                ? cur.full_sentence
                : (cur.answer||cur.word)}</b>`;
    }
    await postResult(score);

    $('#result-msg').html(msg);
    $('#answer,#check-btn').prop('disabled', true);
    $('#next-btn').prop('disabled', false).focus();
    $('#play-btn').show();                      // ÂõûÁ≠îÂæå„Å´Ë°®Á§∫
});


$('#play-btn').on('click', async ()=>{
  if(!cur || !cur.full_sentence) return;

  try{
    const res = await fetch('/api/tts_b64',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text: cur.full_sentence})
    });
    const j = await res.json();
    if(j.error){ alert(j.error); return; }

    const b64 = j.audio_b64 || j.audio;   // ‚òÖ ‰∏°ÊñπË©¶„Åô
    if(!b64){ alert('TTS response missing audio'); return; }

    $('#tts-audio')
       .attr('src','data:audio/mp3;base64,'+b64)
       .get(0).play();
  }catch(e){
    console.error(e);
    alert('Audio error');
  }
});

$('#next-btn').on('click', loadNext);
$(loadNext);

</script>
</body>
</html>
