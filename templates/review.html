<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Review</title>

<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous"/>
<style>
:root{--bg:#1e1e1e;--blue:#3498db;--blue-light:#5dade2;--text:#fff;}
*{box-sizing:border-box;}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Raleway',sans-serif;
     display:flex;justify-content:center;align-items:center;min-height:100vh;}
.container{background:rgba(40,40,40,.85);max-width:540px;width:92%;padding:28px 26px;
           border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);text-align:center;position:relative;}
h1{font-size:1.25rem;margin:0 0 22px}
#jp{font-size:1.2rem;font-weight:600;margin:6px 0 12px;color:var(--blue-light);}
#ef{font-size:.85rem;opacity:.8;margin-bottom:10px;}
#result-msg{margin-top:12px;font-size:1rem;}
input#answer{width:100%;padding:10px;border-radius:6px;border:none;font-size:1rem;}
.btn{margin-top:20px;padding:10px 26px;font-size:1rem;border:none;border-radius:50px;
     background:var(--blue);color:#fff;cursor:pointer;transition:background .2s;}
.btn:hover{background:#2980b9}
.btn:disabled{opacity:.4;cursor:not-allowed;}
#next-btn{margin-top:26px;}
a.home,a.logout{position:absolute;top:18px;color:#fff;text-decoration:none}
a.home{left:20px;font-size:30px}
a.logout{right:20px;padding:8px 14px;background:#7f8c8d;border-radius:6px}
a.logout:hover{background:#95a5a6}
@media(max-width:600px){
  body{align-items:flex-start;padding-top:70px}
  .container{width:100%;height:calc(100vh - 90px);overflow-y:auto}
}

.rec-btn,
.stop-btn{
  background:#FF3B30;   /* Signal Red */
  color:#fff;
  transition:background .2s;
}

.rec-btn:hover,
.stop-btn:hover{
  background:#e12e24;   /* Â∞ë„ÅóÊöó„ÅÑ„Éà„Éº„É≥„Å∏ */
}

.icon-btn.glossy{
  width:28px;           /* ‚ñº Â∞è„Åï„Åè */
  height:28px;
  margin:0 auto;        /* ‚ñº ‰∏≠Â§ÆÂØÑ„Åõ */
  display:block;
  border-radius:50%;
  background:linear-gradient(#5dade2,#3498db);
  border:none;
  color:#fff;
  cursor:pointer;
  box-shadow:0 2px 4px rgba(0,0,0,.4);
  transition:transform .15s;
}

.icon-btn.glossy:hover{
  transform:scale(1.12);
  box-shadow:
      0 6px 16px rgba(0,0,0,.8),
      0 0 0 4px #76c7ff inset;
}
.icon-btn.glossy:active{transform:scale(.95);}

@keyframes pulse{
  0%{ box-shadow:0 0 0 4px #5dade2 inset; }
  50%{ box-shadow:0 0 0 8px #5dade2 inset; }
  100%{ box-shadow:0 0 0 4px #5dade2 inset; }
}
.icon-btn.glossy.playing{ animation:pulse 1s infinite; }

</style>
</head>
<body>

<a href="/home" class="home"><i class="fa-solid fa-house-chimney-window"></i></a>
<a href="/logout" class="logout">Logout</a>

<div class="container">
  <h1>Review</h1>

<div id="player-wrap" style="margin:10px 0">
  <button id="play-btn" class="icon-btn glossy" title="Play sentence" style="display:none">
      <i class="fas fa-volume-up"></i>
  </button>
  <audio id="tts-audio" style="display:none"></audio>
    <audio id="rec-audio" style="display:none"></audio>
</div>

  <div id="prompt">Loading‚Ä¶</div>        <!-- sentence or JP -->
    <div id="jp-trans" style="margin-top:6px;opacity:.8;font-size:.9rem;"></div>
    <div id="ef"></div>

  <input id="answer" placeholder="" autocomplete="off">

    <!-- Èå≤Èü≥ÈñãÂßã -->
    <button id="rec-btn" class="btn rec-btn" style="margin-top:14px;">
        <i class="fas fa-microphone"></i> Rec
    </button>

    <!-- Èå≤Èü≥ÂÅúÊ≠¢ -->
    <button id="stop-btn" class="btn stop-btn" style="display:none;margin-left:8px;">
        <i class="fas fa-stop"></i> Stop
    </button>

  <button id="check-btn" class="btn">Check</button>

  <div id="result-msg"></div>

  <button id="next-btn" class="btn" disabled>Next</button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>

let cur=null;
let mediaRec      = null;   // MediaRecorder „Ç§„É≥„Çπ„Çø„É≥„Çπ
let chunks        = [];     // Èå≤Èü≥„Éá„Éº„Çø
let autoId        = null;   // Ëá™ÂãïÂÅúÊ≠¢„Çø„Ç§„Éû„Éº ID

/* ‚ñº ‚ë† „É¨„Éº„Éô„É≥„Ç∑„É•„Çø„Ç§„É≥Ë∑ùÈõ¢ÔºàÊúÄÂ∞èÁ∑®ÈõÜË∑ùÈõ¢Ôºâ */
function lev(a,b){
  const m=a.length,n=b.length,dp=[...Array(m+1)].map(()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++)
    for(let j=1;j<=n;j++)
      dp[i][j]=Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1)
      );
  return dp[m][n];
}

function loadNext(){
  $('#prompt').text('Loading‚Ä¶'); $('#ef,#result-msg').text('');
  $('#answer').val('').prop('disabled',false).focus();
  $('#check-btn').prop('disabled',false); $('#next-btn').prop('disabled',true);

  $.getJSON('/api/review/next').done(j=>{
      if(j.finished){ $('#prompt').text('üéâ ‰ªäÊó•„ÅØÂÆå‰∫ÜÔºÅ'); $('#answer,#check-btn').prop('disabled',true); return;}
      cur=j;
      $('#play-btn').hide();
      if (j.mode === 'cloze') {
          $('#prompt').text(j.sentence);
          $('#jp-trans').text(j.jp || '');
          $('#answer').attr('placeholder', 'Á©∫Ê¨Ñ„ÇíÂüã„ÇÅ„ÇãËã±ÂçòË™û / Âè•ÂãïË©û');
      } else if(j.mode==='jp'){
          $('#prompt').text(j.jp);
          $('#jp-trans').text('');        // Ë®≥„ÅØ‰∏çË¶Å
          $('#answer').attr('placeholder', 'Êó•Êú¨Ë™û„ÅÆËã±Ë™ûË®≥„ÇíÂÖ•Âäõ');
      }else if(j.mode==='dict'){
          $('#prompt').text('üéß Listen and type the sentence');
          $('#jp-trans').text('');
          $('#answer').attr('placeholder', 'Type what you hear');
          // „Åô„ÅêÈü≥Â£∞ÂÜçÁîü
          $('#tts-audio').attr('src', 'data:audio/mp3;base64,' + j.audio).get(0).play();

          $('#play-btn').show().off('click').on('click', ()=> {
            $('#tts-audio').get(0).currentTime = 0;
            $('#tts-audio').get(0).play();
            $('#play-btn').addClass('playing');
          });
      }
      $('#ef').text('EF: '+j.ef.toFixed(2));
  }).fail(()=>$('#prompt').text('Error'));
}

// ÊàêÂê¶ÁµêÊûú„ÇíDB„Å´Êõ∏„ÅçËæº„ÇÄ„Éò„É´„Éë„ÉºÈñ¢Êï∞
function postResult(score){
  const fd=new FormData();
  fd.append('vocab_id',cur.vocab_id);
  fd.append('score',score);          // ‚Üê correct „Åß„ÅØ„Å™„Åè score
  return fetch('/api/review/result',{method:'POST',body:fd});
}

// Ê≠£Ë¶èÂåñ„Éò„É´„Éë
// Ê≠£Ë¶èÂåñ„Éò„É´„Éë ‚Äï Á∏ÆÁ¥Ñ„ÇíÂ±ïÈñã„Åó„Å¶„Åã„ÇâËã±Â≠ó„Å†„ÅëÊÆã„Åô
const norm = s => s
    .toLowerCase()
    .replace(/‚Äô/g, "'")             // ÂÖ®Ëßí/„Çπ„Éû„Éº„ÉàÂºïÁî® ‚Üí '
    // ‚îÄ‚îÄ Á∏ÆÁ¥ÑÂΩ¢„Çí„ÄåÂ±ïÈñãÂΩ¢„Äç„Å´Áµ±‰∏Ä ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    .replace(/\bi'm\b/g,  'i am')
    .replace(/\byou're\b/g,'you are')
    .replace(/\bhe's\b/g, 'he is')
    .replace(/\bshe's\b/g,'she is')
    .replace(/\bit's\b/g, 'it is')
    .replace(/\bwe're\b/g,'we are')
    .replace(/\bthey're\b/g,'they are')
    .replace(/\bthat's\b/g,'that is')
    .replace(/\bthere's\b/g,'there is')
    .replace(/\bcan't\b/g,'cannot')
    .replace(/\bwon't\b/g,'will not')
    .replace(/\bdon't\b/g,'do not')
    // „Åì„Åì„Å´È†ªÂá∫„Éë„Çø„Éº„É≥„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åë„Åæ„Åô
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    .replace(/[^a-z]/g,'');         // Ëã±Â≠ó‰ª•Â§ñ„ÇíÂâäÈô§


$('#check-btn').on('click', async ()=>{

    const ansNorm = norm($('#answer').val());
    if (!ansNorm) return;
    const target = norm(cur.mode === 'cloze' ? cur.answer
            : cur.mode === 'jp' ? cur.word
                    : cur.full_sentence);  // dict „ÅØÂÖ®Êñá

    const dist = lev(ansNorm, target);
    let score, msg;
    if (dist === 0) {                     // ÂÆåÂÖ®‰∏ÄËá¥
        score = 5;
        msg = '‚úÖ Perfect!';
    } else if (dist <= 2) {                // ¬±2ÊñáÂ≠ó‰ª•ÂÜÖ
        score = 3;
        msg = `üí° Almost! (${dist} typo${dist>1?'s':''})<br>
            Correct: <b>${
                cur.mode==='dict'
                    ? cur.full_sentence
                    : (cur.answer || cur.word)
            }</b>`;
    } else {
        score = 1;
        msg = `‚ùå Correct: <b>${cur.mode==='dict'
                ? cur.full_sentence
                : (cur.answer||cur.word)}</b>`;
    }
    await postResult(score);

    $('#result-msg').html(msg);
    $('#answer,#check-btn').prop('disabled', true);
    $('#next-btn').prop('disabled', false).focus();
    $('#play-btn').show();                      // ÂõûÁ≠îÂæå„Å´Ë°®Á§∫
});


$('#play-btn').on('click', async ()=>{
  if(!cur || !cur.full_sentence) return;

  try{
    const res = await fetch('/api/tts_b64',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text: cur.full_sentence})
    });
    const j = await res.json();
    if(j.error){ alert(j.error); return; }

    const b64 = j.audio_b64 || j.audio;   // ‚òÖ ‰∏°ÊñπË©¶„Åô
    if(!b64){ alert('TTS response missing audio'); return; }

    $('#tts-audio')
       .attr('src','data:audio/mp3;base64,'+b64)
       .get(0).play();
  }catch(e){
    console.error(e);
    alert('Audio error');
  }
});

$('#next-btn').on('click', loadNext);
$(loadNext);


/* ‚ñº Èå≤Èü≥ÈñãÂßã -------------------------------- */
async function startRec(){
  try{
    const stream   = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRec       = new MediaRecorder(stream);
    chunks.length  = 0;

    mediaRec.ondataavailable = e => chunks.push(e.data);
    mediaRec.onstop          = sendRec;   // ‚Üê Èå≤Èü≥ÁµÇ‰∫ÜÂæå„Å´ÈÄÅ‰ø°

    mediaRec.start();

    /* 10 Áßí„ÅßËá™ÂãïÂÅúÊ≠¢ */
    autoId = setTimeout(stopRec, 10_000);

    /* UI ÂàáÊõø */
    $('#rec-btn').prop('disabled', true);
    $('#stop-btn').show();
  }catch(err){
    alert('üé§ „Éû„Ç§„ÇØ„Åå‰Ωø„Åà„Åæ„Åõ„Çì: ' + err);
  }
}

/* ‚ñº ÊâãÂãïÔºèËá™ÂãïÂÖ±ÈÄö: Èå≤Èü≥ÂÅúÊ≠¢ ------------------ */
function stopRec(){
  if(!mediaRec || mediaRec.state !== 'recording') return;
  clearTimeout(autoId);
  mediaRec.stop();           // onstop „Åß sendRec „ÅåÂëº„Å∞„Çå„Çã

  /* UI Êàª„Åô */
  $('#rec-btn').prop('disabled', false);
  $('#stop-btn').hide();
}

/* ‚ñº Èå≤Èü≥„Éá„Éº„Çø„ÇíÈÄÅ‰ø° --------------------------- */
async function sendRec(){
  const blob = new Blob(chunks, {type:'audio/webm'});
  const fd   = new FormData();
  fd.append('audio', blob, 'speech.webm');

  try{
    const res = await fetch('/api/stt_to_text', {method:'POST', body:fd});
    const j   = await res.json();
    if(j.text){
      $('#answer').val(j.text).focus();        // „ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•ÂäõÊ¨Ñ„Å∏
    }else{
      alert(j.error || 'STT error');
    }
  }catch(e){
    console.error(e);
    alert('Upload failed');
  }
}

/* ‚ñº „Ç§„Éô„É≥„ÉàÁôªÈå≤ ------------------------------- */
$('#rec-btn').on('click', startRec);   // Èå≤Èü≥ÈñãÂßã
$('#stop-btn').on('click', stopRec);   // ÊâãÂãïÂÅúÊ≠¢


</script>
</body>
</html>
