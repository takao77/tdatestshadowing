<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Review</title>

<link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" crossorigin="anonymous"/>
<style>
:root{--bg:#1e1e1e;--blue:#3498db;--blue-light:#5dade2;--text:#fff;}
*{box-sizing:border-box;}
body{margin:0;background:var(--bg);color:var(--text);font-family:'Raleway',sans-serif;
     display:flex;justify-content:center;align-items:center;min-height:100vh;}
.container{background:rgba(40,40,40,.85);max-width:540px;width:92%;padding:28px 26px;
           border-radius:14px;box-shadow:0 4px 20px rgba(0,0,0,.3);text-align:center;position:relative;}
h1{font-size:1.25rem;margin:0 0 22px}
#jp{font-size:1.2rem;font-weight:600;margin:6px 0 12px;color:var(--blue-light);}
#ef{font-size:.85rem;opacity:.8;margin-bottom:10px;}
#result-msg{margin-top:12px;font-size:1rem;}
input#answer{width:100%;padding:10px;border-radius:6px;border:none;font-size:1rem;}
.btn{margin-top:20px;padding:10px 26px;font-size:1rem;border:none;border-radius:50px;
     background:var(--blue);color:#fff;cursor:pointer;transition:background .2s;}
.btn:hover{background:#2980b9}
.btn:disabled{opacity:.4;cursor:not-allowed;}
#next-btn{margin-top:26px;}
a.home,a.logout{position:absolute;top:18px;color:#fff;text-decoration:none}
a.home{left:20px;font-size:30px}
a.logout{right:20px;padding:8px 14px;background:#7f8c8d;border-radius:6px}
a.logout:hover{background:#95a5a6}
@media(max-width:600px){
  body{align-items:flex-start;padding-top:70px}
  .container{width:100%;height:calc(100vh - 90px);overflow-y:auto}
}

.rec-btn,
.stop-btn{
  background:#FF3B30;   /* Signal Red */
  color:#fff;
  transition:background .2s;
}

.rec-btn:hover,
.stop-btn:hover{
  background:#e12e24;   /* å°‘ã—æš—ã„ãƒˆãƒ¼ãƒ³ã¸ */
}

.icon-btn.glossy{
  width:28px;           /* â–¼ å°ã•ã */
  height:28px;
  margin:0 auto;        /* â–¼ ä¸­å¤®å¯„ã› */
  display:block;
  border-radius:50%;
  background:linear-gradient(#5dade2,#3498db);
  border:none;
  color:#fff;
  cursor:pointer;
  box-shadow:0 2px 4px rgba(0,0,0,.4);
  transition:transform .15s;
}

.icon-btn.glossy:hover{
  transform:scale(1.12);
  box-shadow:
      0 6px 16px rgba(0,0,0,.8),
      0 0 0 4px #76c7ff inset;
}
.icon-btn.glossy:active{transform:scale(.95);}

@keyframes pulse{
  0%{ box-shadow:0 0 0 4px #5dade2 inset; }
  50%{ box-shadow:0 0 0 8px #5dade2 inset; }
  100%{ box-shadow:0 0 0 4px #5dade2 inset; }
}
.icon-btn.glossy.playing{ animation:pulse 1s infinite; }

</style>
</head>
<body>

<a href="/home" class="home"><i class="fa-solid fa-house-chimney-window"></i></a>
<a href="/logout" class="logout">Logout</a>

<div class="container">
  <h1>Review</h1>

<div id="player-wrap" style="margin:10px 0">
  <button id="play-btn" class="icon-btn glossy" title="Play sentence" style="display:none">
      <i class="fas fa-volume-up"></i>
  </button>
  <audio id="tts-audio" style="display:none"></audio>
    <audio id="rec-audio" style="display:none"></audio>
</div>

  <div id="prompt">Loadingâ€¦</div>        <!-- sentence or JP -->
    <div id="jp-trans" style="margin-top:6px;opacity:.8;font-size:.9rem;"></div>
    <div id="ef"></div>

  <input id="answer" placeholder="" autocomplete="off">

    <!-- éŒ²éŸ³é–‹å§‹ -->
    <button id="rec-btn" class="btn rec-btn" style="margin-top:14px;">
        <i class="fas fa-microphone"></i> Rec
    </button>

    <!-- éŒ²éŸ³åœæ­¢ -->
    <button id="stop-btn" class="btn stop-btn" style="display:none;margin-left:8px;">
        <i class="fas fa-stop"></i> Stop
    </button>

  <button id="check-btn" class="btn">Check</button>

  <div id="result-msg"></div>

  <button id="next-btn" class="btn" disabled>Next</button>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

<script>

let cur=null;
let mediaRec      = null;   // MediaRecorder ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
let chunks        = [];     // éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿
let autoId        = null;   // è‡ªå‹•åœæ­¢ã‚¿ã‚¤ãƒãƒ¼ ID

/* â–¼ â‘  ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ï¼ˆæœ€å°ç·¨é›†è·é›¢ï¼‰ */
function lev(a,b){
  const m=a.length,n=b.length,dp=[...Array(m+1)].map(()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++)
    for(let j=1;j<=n;j++)
      dp[i][j]=Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+(a[i-1]===b[j-1]?0:1)
      );
  return dp[m][n];
}

function loadNext(){
  $('#prompt').text('Loadingâ€¦'); $('#ef,#result-msg').text('');
  $('#answer').val('').prop('disabled',false).focus();
  $('#check-btn').prop('disabled',false); $('#next-btn').prop('disabled',true);

  $.getJSON('/api/review/next').done(j=>{
      if(j.finished){ $('#prompt').text('ğŸ‰ ä»Šæ—¥ã¯å®Œäº†ï¼'); $('#answer,#check-btn').prop('disabled',true); return;}
      cur=j;
      $('#play-btn').hide();
      if (j.mode === 'cloze') {
          $('#prompt').text(j.sentence);
          $('#jp-trans').text(j.jp || '');
          $('#answer').attr('placeholder', 'ç©ºæ¬„ã‚’åŸ‹ã‚ã‚‹è‹±å˜èª / å¥å‹•è©');
      } else if(j.mode==='jp'){
          $('#prompt').text(j.jp);
          $('#jp-trans').text('');        // è¨³ã¯ä¸è¦
          $('#answer').attr('placeholder', 'æ—¥æœ¬èªã®è‹±èªè¨³ã‚’å…¥åŠ›');
      }else if(j.mode==='dict'){
          $('#prompt').text('ğŸ§ Listen and type the sentence');
          $('#jp-trans').text('');
          $('#answer').attr('placeholder', 'Type what you hear');
          // ã™ãéŸ³å£°å†ç”Ÿ
          $('#tts-audio').attr('src', 'data:audio/mp3;base64,' + j.audio).get(0).play();

          $('#play-btn').show().off('click').on('click', ()=> {
            $('#tts-audio').get(0).currentTime = 0;
            $('#tts-audio').get(0).play();
            $('#play-btn').addClass('playing');
          });
      }
      $('#ef').text('EF: '+j.ef.toFixed(2));
  }).fail(()=>$('#prompt').text('Error'));
}

// æˆå¦çµæœã‚’DBã«æ›¸ãè¾¼ã‚€ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
function postResult(score){
  const fd=new FormData();
  fd.append('vocab_id',cur.vocab_id);
  fd.append('score',score);          // â† correct ã§ã¯ãªã score
  return fetch('/api/review/result',{method:'POST',body:fd});
}

// æ­£è¦åŒ–ãƒ˜ãƒ«ãƒ‘
// æ­£è¦åŒ–ãƒ˜ãƒ«ãƒ‘ â€• ç¸®ç´„ã‚’å±•é–‹ã—ã¦ã‹ã‚‰è‹±å­—ã ã‘æ®‹ã™
const norm = s => s
    .toLowerCase()
    .replace(/â€™/g, "'")             // å…¨è§’/ã‚¹ãƒãƒ¼ãƒˆå¼•ç”¨ â†’ '
    // â”€â”€ ç¸®ç´„å½¢ã‚’ã€Œå±•é–‹å½¢ã€ã«çµ±ä¸€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    .replace(/\bi'm\b/g,  'i am')
    .replace(/\byou're\b/g,'you are')
    .replace(/\bhe's\b/g, 'he is')
    .replace(/\bshe's\b/g,'she is')
    .replace(/\bit's\b/g, 'it is')
    .replace(/\bwe're\b/g,'we are')
    .replace(/\bthey're\b/g,'they are')
    .replace(/\bthat's\b/g,'that is')
    .replace(/\bthere's\b/g,'there is')
    .replace(/\bcan't\b/g,'cannot')
    .replace(/\bwon't\b/g,'will not')
    .replace(/\bdon't\b/g,'do not')
    // ã“ã“ã«é »å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¿½åŠ ã—ã¦ã„ã‘ã¾ã™
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    .replace(/[^a-z]/g,'');         // è‹±å­—ä»¥å¤–ã‚’å‰Šé™¤


$('#check-btn').on('click', async ()=>{

    const ansNorm = norm($('#answer').val());
    if (!ansNorm) return;
    const target = norm(cur.mode === 'cloze' ? cur.answer
            : cur.mode === 'jp' ? cur.word
                    : cur.full_sentence);  // dict ã¯å…¨æ–‡

    const dist = lev(ansNorm, target);
    let score, msg;
    if (dist === 0) {                     // å®Œå…¨ä¸€è‡´
        score = 5;
        msg = 'âœ… Perfect!';
    } else if (dist <= 2) {                // Â±2æ–‡å­—ä»¥å†…
        score = 3;
        msg = `ğŸ’¡ Almost! (${dist} typo${dist>1?'s':''})<br>
            Correct: <b>${
                cur.mode==='dict'
                    ? cur.full_sentence
                    : (cur.answer || cur.word)
            }</b>`;
    } else {
        score = 1;
        msg = `âŒ Correct: <b>${cur.mode==='dict'
                ? cur.full_sentence
                : (cur.answer||cur.word)}</b>`;
    }
    await postResult(score);

    $('#result-msg').html(msg);
    $('#answer,#check-btn').prop('disabled', true);
    $('#next-btn').prop('disabled', false).focus();
    $('#play-btn').show();                      // å›ç­”å¾Œã«è¡¨ç¤º
});


$('#play-btn').on('click', async ()=>{
  if(!cur || !cur.full_sentence) return;

  try{
    const res = await fetch('/api/tts_b64',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({text: cur.full_sentence})
    });
    const j = await res.json();
    if(j.error){ alert(j.error); return; }

    const b64 = j.audio_b64 || j.audio;   // â˜… ä¸¡æ–¹è©¦ã™
    if(!b64){ alert('TTS response missing audio'); return; }

    $('#tts-audio')
       .attr('src','data:audio/mp3;base64,'+b64)
       .get(0).play();
  }catch(e){
    console.error(e);
    alert('Audio error');
  }
});

$('#next-btn').on('click', loadNext);
$(loadNext);


/* â–¼ éŒ²éŸ³é–‹å§‹ -------------------------------- */
async function startRec(){
  try{
    const stream   = await navigator.mediaDevices.getUserMedia({audio:true});
    mediaRec       = new MediaRecorder(stream);
    chunks.length  = 0;

    mediaRec.ondataavailable = e => chunks.push(e.data);
    mediaRec.onstop          = sendRec;   // â† éŒ²éŸ³çµ‚äº†å¾Œã«é€ä¿¡

    mediaRec.start();

    /* 10 ç§’ã§è‡ªå‹•åœæ­¢ */
    autoId = setTimeout(stopRec, 10_000);

    /* UI åˆ‡æ›¿ */
    $('#rec-btn').prop('disabled', true);
    $('#stop-btn').show();
  }catch(err){
    alert('ğŸ¤ ãƒã‚¤ã‚¯ãŒä½¿ãˆã¾ã›ã‚“: ' + err);
  }
}

/* â–¼ æ‰‹å‹•ï¼è‡ªå‹•å…±é€š: éŒ²éŸ³åœæ­¢ ------------------ */
function stopRec(){
  if(!mediaRec || mediaRec.state !== 'recording') return;
  clearTimeout(autoId);
  mediaRec.stop();           // onstop ã§ sendRec ãŒå‘¼ã°ã‚Œã‚‹

  /* UI æˆ»ã™ */
  $('#rec-btn').prop('disabled', false);
  $('#stop-btn').hide();
}

/* â–¼ éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ã‚’é€ä¿¡ --------------------------- */
async function sendRec(){
  const blob = new Blob(chunks, {type:'audio/webm'});
  const fd   = new FormData();
  fd.append('audio', blob, 'speech.webm');

  try{
    const res = await fetch('/api/stt_to_text', {method:'POST', body:fd});
    const j   = await res.json();
    if(j.text){
      $('#answer').val(j.text).focus();        // ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›æ¬„ã¸
    }else{
      alert(j.error || 'STT error');
    }
  }catch(e){
    console.error(e);
    alert('Upload failed');
  }
}

/* â–¼ ã‚¤ãƒ™ãƒ³ãƒˆç™»éŒ² ------------------------------- */
$('#rec-btn').on('click', startRec);   // éŒ²éŸ³é–‹å§‹
$('#stop-btn').on('click', stopRec);   // æ‰‹å‹•åœæ­¢


</script>
</body>
</html>
