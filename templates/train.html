<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>AI Train Mode – Polyagent</title>

  <!-- fonts / icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      --accent:#00e6ff; --bg:#0e0e0e; --card:#1b1b1b; --text:#f5f5f5;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      background:var(--bg);color:var(--text);font-family:'Poppins',sans-serif;
      min-height:100vh;display:flex;flex-direction:column;
    }
    header{
      display:flex;align-items:center;gap:.8rem;padding:18px 5vw;
    }
    header h1{font-size:1.3rem;font-weight:600;flex:1}
    header button.back{background:none;border:none;color:#fff;font-size:1.3rem;cursor:pointer}
    /* ── controls (上部) ───────────────────────── */
    .ctrls{
      display:flex;gap:1.4rem;justify-content:center;margin:6px 0 10px;
    }
    .btn{
      background:var(--accent);border:none;color:#000;font-weight:600;
      padding:.55rem 1.8rem;border-radius:28px;font-size:1rem;cursor:pointer;
      transition:.25s;
    }
    .btn:hover{opacity:.85}
    main{
      flex:1;display:flex;flex-direction:column;align-items:center;gap:1.4rem;
      padding:1.5rem 5vw 4rem;
    }
    .card{
      background:var(--card);border:1px solid #333;border-radius:18px;
      padding:1.3rem;width:100%;max-width:600px;
    }
    .words-list{
      display:grid;grid-template-columns:1fr 3fr;row-gap:.6rem;font-size:.95rem;
    }
    .words-list span:first-child{font-weight:600;color:var(--accent)}
    .sakura{margin-top:1.2rem;font-size:.95rem;white-space:pre-wrap;line-height:1.45}
    #loading{padding:36px 0;font-size:1.05rem;text-align:center}
  </style>
</head>
<body>
  <header>
    <button class="back" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
    <h1>Train&nbsp;Mode&nbsp;電車モード</h1>
  </header>

  <!-- ★ コントロールをヘッダー下へ移動 -->
  <div class="ctrls">
    <button class="btn" id="btnStart"><i class="fas fa-play"></i>&nbsp;Start</button>
    <button class="btn" id="btnPause"><i class="fas fa-pause"></i>&nbsp;Pause</button>
    <button class="btn" id="btnNext"><i class="fas fa-forward"></i>&nbsp;Next</button>
  </div>

  <main>
    <div class="card" id="stage">
      <div id="loading">Loading…</div>

      <div id="content" style="display:none">
        <h2 style="font-size:1.05rem;margin-bottom:.8rem">Focus Words</h2>
        <div class="words-list" id="wordGrid"><!-- inject --></div>

        <h2 style="margin:1.2rem 0 .4rem">Example Sentence</h2>
        <p id="exampleText" style="font-size:1rem;line-height:1.4"></p>

        <div class="sakura" id="sakuraText"><!-- inject --></div>
      </div>
    </div>
  </main>

  <!-- audio elements -->
  <audio id="audioIntro"     playsinline></audio>
  <audio id="audioSentence"  playsinline></audio>
  <audio id="audioStory"     playsinline></audio>
  <audio id="audioReview"    playsinline></audio>

  <script>
    /* ---------- DOM refs ---------- */
    const audioIntro     = document.getElementById('audioIntro');
    const audioSentence  = document.getElementById('audioSentence');
    const audioStory     = document.getElementById('audioStory');
    const audioReview    = document.getElementById('audioReview');
    const loadingEl      = document.getElementById('loading');
    const contentEl      = document.getElementById('content');
    const gridEl         = document.getElementById('wordGrid');
    const sakuraEl       = document.getElementById('sakuraText');
    const exampleEl      = document.getElementById('exampleText');

    const audios = [audioIntro, audioSentence, audioStory, audioReview];
    let currentAudio = null;          // ★ 直近に再生された audio
    let paused = false;

    /* ---------- 再生チェーン ---------- */
    audioIntro.onplay    = ()=> currentAudio = audioIntro;
    audioSentence.onplay = ()=> currentAudio = audioSentence;
    audioStory.onplay    = ()=> currentAudio = audioStory;
    audioReview.onplay   = ()=> currentAudio = audioReview;

    audioIntro.onended    = () => audioSentence.play();
    audioSentence.onended = () => audioStory.play();
    audioStory.onended    = () => audioReview.play();

    /* ---------- Pause / Resume ---------- */
    document.getElementById('btnPause').onclick = () => {
      if (!paused) {                       // ① Pause
        if (currentAudio) currentAudio.pause();
        document.getElementById('btnPause').innerHTML =
          '<i class="fas fa-play"></i>&nbsp;Resume';
      } else {                             // ② Resume
        if (currentAudio &&
            currentAudio.currentTime < currentAudio.duration) {
          currentAudio.play();
        }
        document.getElementById('btnPause').innerHTML =
          '<i class="fas fa-pause"></i>&nbsp;Pause';
      }
      paused = !paused;
    };

    /* ---------- 再生開始 / リピート ---------- */
    function playSequence(){
      audios.forEach(a=>{ a.pause(); a.currentTime = 0; });
      currentAudio = audioIntro;

      paused = false;                                              // ←① フラグ初期化
        document.getElementById('btnPause').innerHTML =              // ←② ラベル復帰
        '<i class="fas fa-pause"></i>&nbsp;Pause';

      audioIntro.play();
    }

    document.getElementById('btnStart').onclick = playSequence;

    /* ---------- 次のラウンド ---------- */
    document.getElementById('btnNext').onclick = loadRound;

    /* ---------- round fetch ---------- */
    function loadRound(){
      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      fetch('/api/train_round')
        .then(r => r.json())
        .then(j => {
          /* --- テキスト表示 --- */
          gridEl.innerHTML = '';
          j.words.forEach(w=>{
            gridEl.insertAdjacentHTML(
              'beforeend',
              `<span>${w.word}</span><span>${w.sentence}</span>`
            );
          });
          sakuraEl.textContent  = j.sakura_text   || '';
          exampleEl.textContent = j.example_sentence || '';

          /* --- 音声セット --- */
          audioIntro.src    = 'data:audio/mp3;base64,' + j.intro_audio;
          audioSentence.src = 'data:audio/mp3;base64,' + j.sentence_audio;
          audioStory.src    = 'data:audio/mp3;base64,' + j.story_audio;
          audioReview.src   = 'data:audio/mp3;base64,' + j.review_audio;

          /* --- UI 切替 --- */
          loadingEl.style.display = 'none';
          contentEl.style.display = 'block';
          playSequence();                       // ← 自動で再生開始
        })
        .catch(e=>{
          console.error(e);
          loadingEl.textContent = 'Error loading';
        });
    }

    /* ---------- 初回ロード ---------- */
    loadRound();
  </script>
</body>
</html>